<% provide(:disable_alert, "hidden") %>
<div ng-app="invitation_app"  ng-controller="InvitationCtrl"
	ng-init="invitationKey='<%= @invitation_key %>';session=<%= @accepted_session.to_json() %>; validation=<%= @validation.to_json %>; init();">

	<div style="">
		<span class="zyxel_span2" ng-switch on="step">
		  <span ng-switch-when="connecting">
		  	<%= I18n.t("warnings.settings.invitation.connecting") %>
		  </span>
		  <span ng-switch-when="failure">
		  	<%= I18n.t("warnings.settings.invitation.failure") %>
		  	<blockquote style="border-left: white;white-space:normal">
		  		<%= I18n.t("warnings.settings.invitation.failure_desc", :share_point => "#{@share_point}") %>
		  	</blockquote>
		  </span>
		  <span ng-switch-when="done">
		  	<%= I18n.t("warnings.settings.invitation.success") %>
		  	<blockquote style="border-left: white;white-space: normal;">
		  		<%= I18n.t("warnings.settings.invitation.success_desc", :share_point => "#{@share_point}") %>
		  	</blockquote>
		  </span>
		</span>
	</div>

	<div class="bottom-content" ng-switch on="panel">
    <div class="countdown" ng-switch-when="loading">
      <%= image_tag 'loading.gif' %>
    </div>
    <div class="zyxel_btn_area i18n_fix" ng-switch-when="retry">
      <%= link_to(I18n.t("labels.retry"), "/invitations/accept/#{@invitation_key}", class: "zyxel_btn_ok zyxel_enabled") %>
    </div>
    <div class="zyxel_btn_area" ng-switch-when="done">
      <%= link_to(I18n.t("labels.confirm"), "/discoverer/index", class: "zyxel_btn_ok") %>
    </div>
  </div>
</div>

<script type="text/javascript">
	var invitation_app = angular.module('invitation_app', []);
	invitation_app.controller('InvitationCtrl', function ($scope, $timeout, $http) {
		$scope.step = 'connecting';
    $scope.panel = 'loading';
		$scope.checkConnectionUrl = '/invitations/check_connection/';
		$scope.interval = 3000;

	    $scope.init = function(){
	    	if($scope.validation.success == false){
	    		$scope.failureStep();
	    		return;
	    	}
		    if($scope.session.status == 'start'){
			    $scope.connectingStep();
			    $scope.checkConnection();
		    }
	    };

	    $scope.checkConnection = function(){
		    switch($scope.session.status){
		      case 'start':
		      	$scope.poll();
		      	break;
		      case 'timeout':
		      	// timeout 時顯示 "接受失敗"
		        $scope.failureStep();
		        break;
		      case 'failure':
		        $scope.failureStep();
		        break;
		      case 'done':
		        $scope.completedStep();
		        break;
		    }
	    };

	    $scope.poll = function(){
	    	if($scope.invitationKey != ''){
			    var url = $scope.checkConnectionUrl + $scope.invitationKey;
			    $timeout(function(){
				    $http.get(url).success(function(response) {
				        $scope.session = response;
				        $scope.checkConnection();
				    }).error(function(response){
				        $scope.failureStep();
				    });
			    }, $scope.interval);
		    }
	    };

	    $scope.connectingStep = function(){
	      $scope.step = 'connecting';
	      $scope.panel = 'loading';
	    };
	    $scope.failureStep = function(){
	      $scope.step = 'failure';
	      $scope.panel = 'retry';
	    };

	    $scope.completedStep = function(){
	      $scope.step = 'done';
	      $scope.panel = 'done';
	    };

	});
</script>
